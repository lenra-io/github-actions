name: Build Flutter App
# description: Build Flutter app for the chosen targets. Will output the build file(s) for the selected platform as an artifact.

on:
  workflow_call:
    inputs:
      working-directory:
        type: string
        description: 'Current Working directory (Useful for mono-repo and run this only in this directory)'
        required: false
        default: '.'
      version:
        type: string
        description: 'Version to build'
        required: true
      build:
        type: string
        description: 'Build identifier'
        required: true
      flutter-version:
        type: string
        description: 'Version of Flutter to use'
        required: false
      flutter-channel:
        type: string
        description: 'Channel of Flutter to use'
        required: false
        default: 'stable'
      flutter-build-args:
        type: string
        description: 'Comma separated list of flutter build extra args (e.g., release,verbose,obfuscate,split-debug-info=.debug,split-per-abi)'
        required: false
        default: '--release'
      platform:
        type: string
        description: 'Target platform'
        required: true
      targets:
        type: string
        description: 'Build targets (comma separated if many)'
        required: true
      runner:
        type: string
        description: 'Runner label (e.g., ubuntu-latest, macos-latest, windows-latest)'
        required: true
      artifact-name:
        type: string
        description: 'Give a name for build artifacts'
        required: false
      artifact-path:
        type: string
        description: 'Glob pattern for build artifacts'
        required: false
      ios-app-identifier:
        type: string
        description: 'iOS app identifier (e.g. com.example.app)'
      ios-export-method:
        type: string
        description: 'iOS export method (app-store, ad-hoc, enterprise, development)'
        required: false
        default: 'app-store'
    secrets:
      UPLOAD_KEY_STORE:
        description: 'Keystore fi--build-numberle content for Android signing'
        required: false
      UPLOAD_KEY_NAME:
        description: 'Alias name for the Android key'
        required: false
      UPLOAD_KEY_PASSWORD:
        description: 'Password for the Android key'
        required: false
      UPLOAD_STORE_PASSWORD:
        description: 'Password for the Android keystore'
        required: false
      IOS_SIGN_CERT:
        description: 'iOS signing certificate (P12) in base64'
        required: false
      IOS_SIGN_CERT_PASSWORD:
        description: 'Password for the P12 certificate'
        required: false
      IOS_PROVISIONING_PROFILE:
        description: 'iOS provisioning profile in base64'
        required: false
    outputs:
      artifact-id:
        description: 'The ID of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact-id }}
      artifact-url:
        description: 'The URL of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact-url }}

jobs:
  build:
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    runs-on: ${{ inputs.runner }}
    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}
      artifact-url: ${{ steps.upload-artifact.outputs.artifact-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: ${{ inputs.flutter-channel }}
          flutter-version: ${{ inputs.flutter-version }}
          cache: true

      - name: Generate Keystore
        if: inputs.platform == 'android'
        uses: lenra-io/github-actions/jobs/android-keystore@main
        with:
          path: '${{ inputs.working-directory }}/android/key.properties'
          upload-key-store: ${{ secrets.UPLOAD_KEY_STORE }}
          upload-key-name: ${{ secrets.UPLOAD_KEY_NAME }}
          upload-store-password: ${{ secrets.UPLOAD_STORE_PASSWORD }}
          upload-key-password: ${{ secrets.UPLOAD_KEY_PASSWORD }}

      - name: Update version
        uses: actions/github-script@v7
        with:
          debug: true
          script: |
            // Update pubspec.yaml inplace
            const fs = require('fs')
            const path = require('path')
            const pubspecPath = path.join('${{ inputs.working-directory}}', 'pubspec.yaml')
            // edit version and build number
            if (!fs.existsSync(pubspecPath)) {
              throw new Error(`pubspec.yaml file not found at ${pubspecPath}`);
            }
            let pubspec;
            try {
              pubspec = fs.readFileSync(pubspecPath, 'utf8');
            } catch (err) {
              throw new Error(`Failed to read pubspec.yaml: ${err.message}`);
            }
    
            // Remove channel from version, if we have `1.0.0-beta.1`, we want `1.0.0`
            const version = '${{ inputs.version }}'.replace(/-.*$/, '')
    
            const newPubspec = pubspec.replace(/version: .*/, `version: ${version}`)
            try {
              fs.writeFileSync(pubspecPath, newPubspec);
            } catch (err) {
              throw new Error(`Failed to write to pubspec.yaml: ${err.message}`);
            }

      - name: Install Dependencies (linux)
        shell: sh
        if: contains(inputs.targets, 'appimage')
        run: |
          sudo apt-get update -y
          sudo apt-get install -y make cmake ninja-build libgtk-3-dev locate libfuse2 libsecret-1-dev libjsoncpp-dev
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          mv appimagetool /usr/local/bin/
    
      - name: Cache Gradle
        uses: actions/cache@v4.3.0
        if: inputs.platform == 'android'
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/daemon
            ${{ inputs.working-directory }}/android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties', '**/build.gradle*', '**/gradle.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Setup Gradle
        if: inputs.platform == 'android'
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.configureondemand=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError" >> ~/.gradle/gradle.properties

      - name: Install Dependencies (macos)
        shell: sh
        if: contains(inputs.targets, 'dmg')
        run: |
          npm install -g appdmg
          
      # - name: Cache Android
      #   uses: actions/cache@v4.2.3
      #   if: inputs.platform == 'android'
      #   with:
      #     path: |
      #       /usr/local/lib/android/sdk
      #       ~/.android
      #       ${{ inputs.working-directory }}/android/build
      #       ${{ inputs.working-directory }}/build
      #     key: android-sdk-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', '**/android/build.gradle', '**/android/app/build.gradle') }}
      #     restore-keys: |
      #       android-sdk-${{ runner.os }}-
          
      - name: Cache Flutter build
        uses: actions/cache@v4.2.3
        with:
          path: |
            ${{ inputs.working-directory }}/build
            ~/.pub-cache
          key: flutter-build-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-build-${{ runner.os }}-

      - name: Install iOS provisioning profiles
        if: inputs.platform == 'ios'
        env:
          IOS_APP_IDENTIFIER: ${{ inputs.ios-app-identifier }}
          FASTLANE_SIGN_CERT: ${{ secrets.IOS_SIGN_CERT }}
          FASTLANE_SIGN_CERT_PASSWORD: ${{ secrets.IOS_SIGN_CERT_PASSWORD }}
          FASTLANE_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          certificate_dir="$(mktemp -d)"

          # Create a temporary keychain for CI
          KEYCHAIN_NAME="fastlane_tmp_keychain"
          KEYCHAIN_PASSWORD="temp_password_$(date +%s)"
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | sed s/\"//g)
          security default-keychain -s "$KEYCHAIN_NAME"

          # Import certificate
          echo "${FASTLANE_SIGN_CERT}" | base64 -d > ${certificate_dir}/cert.p12
          fastlane run import_certificate \
            certificate_path:"${certificate_dir}/cert.p12" \
            certificate_password:"$FASTLANE_SIGN_CERT_PASSWORD" \
            keychain_name:"$KEYCHAIN_NAME" \
            keychain_password:"$KEYCHAIN_PASSWORD"

          # Import provisioning profile from base64
          echo "${FASTLANE_PROVISIONING_PROFILE}" | base64 -d > "${certificate_dir}/profile.mobileprovision"
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< $(security cms -D -i ${certificate_dir}/profile.mobileprovision))
          
          pp_dir="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$pp_dir"
          cp "${certificate_dir}/profile.mobileprovision" "${pp_dir}/${PP_UUID}.mobileprovision"
          
          fastlane run install_provisioning_profile path:"${certificate_dir}/profile.mobileprovision"
          if [ ! -f ios/ExportOptions.plist ]; then

            cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${{ inputs.ios-export-method }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_APP_IDENTIFIER}</key>
              <string>${PP_UUID}</string>
            </dict>
          </dict>
          </plist>
          EOF
          fi

      - id: build
        name: Build App for ${{ inputs.platform }}
        shell: bash
        run: |
          set -e
          version="${{ inputs.version }}"
          build="${{ inputs.build }}"
          
          echo "Building for platform: ${{ inputs.platform }}"
          echo "Version: ${{ inputs.version }}"
          echo "Build ID: ${{ inputs.build }}"
          echo "Targets: ${{ inputs.targets }}"

          # Parse flutter build args
          IOS_PP_BUILD_ARGS="${{ steps.ios-provisioning.outputs.build-args }}"
          IFS=',' read -ra BUILD_ARGS <<< "${IOS_PP_BUILD_ARGS:-"${{ inputs.flutter-build-args }}"}"
          
          # Parse targets
          IFS=',' read -ra TARGET_LIST <<< "${{ inputs.targets }}"
          
          # Get dependencies
          flutter pub get
          
          BUILD_ARGS+=("--build-number=${build}" "--build-name=${version%%-*}")
          
          if [ '${{ inputs.platform }}' = 'ios' ]; then
            if [[ ${BUILD_ARGS} != *'--export-options-plist'* ]]; then
              IOS_BUILD_ARGS=("--export-options-plist=ios/ExportOptions.plist")
            fi
          fi

          # Build for each target
          for target in "${TARGET_LIST[@]}"; do
            target=$(echo "$target" | xargs) # trim whitespace
            echo "Building target: $target"
            echo "Build command: flutter build $target ${BUILD_ARGS[@]} ${IOS_BUILD_ARGS[@]}"
            flutter build $target ${BUILD_ARGS[@]} ${IOS_BUILD_ARGS[@]}
          done

      - id: upload-artifact
        name: Upload build artifacts
        if: inputs.artifact-name != '' && inputs.artifact-path != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory }}/${{ inputs.artifact-path }}
